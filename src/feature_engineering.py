"""
ì§€í•˜ì²  í˜¼ì¡ë„ ì˜ˆì¸¡ - í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ëª¨ë“ˆ
subway-congestion-prediction/src/feature_engineering.py

ì£¼ìš” ê¸°ëŠ¥:
1. ì‹œê°„ ê¸°ë°˜ í”¼ì²˜ (ìš”ì¼, ê³µíœ´ì¼, ì£¼ë§ ë“±)
2. í†µê³„ ê¸°ë°˜ í”¼ì²˜ (ì´ë™í‰ê· , í‘œì¤€í¸ì°¨ ë“±)
3. ë²”ì£¼í˜• í”¼ì²˜ ì¸ì½”ë”©
4. ìƒí˜¸ì‘ìš© í”¼ì²˜ ìƒì„±
5. ë‚ ì”¨ ë°ì´í„° í†µí•© (ì„ íƒì‚¬í•­)
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import os
import warnings
warnings.filterwarnings('ignore')


class FeatureEngineer:
    """í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ í´ë˜ìŠ¤"""
    
    def __init__(self, processed_data_path, feature_data_path):
        """
        Args:
            processed_data_path: ì „ì²˜ë¦¬ëœ ë°ì´í„° ê²½ë¡œ
            feature_data_path: í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ê²°ê³¼ ì €ì¥ ê²½ë¡œ
        """
        self.processed_data_path = processed_data_path
        self.feature_data_path = feature_data_path
        
        # í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
        os.makedirs(feature_data_path, exist_ok=True)
        
        self.df = None
        
    def load_processed_data(self, filename='subway_processed.csv'):
        """ì „ì²˜ë¦¬ëœ ë°ì´í„° ë¡œë“œ"""
        filepath = os.path.join(self.processed_data_path, filename)
        
        print(f"ğŸ“‚ ì „ì²˜ë¦¬ ë°ì´í„° ë¡œë”© ì¤‘: {filepath}")
        
        self.df = pd.read_csv(filepath, encoding='utf-8-sig')
        
        # ë‚ ì§œ ì»¬ëŸ¼ì„ datetimeìœ¼ë¡œ ë³€í™˜
        self.df['ì‚¬ìš©ì¼ì'] = pd.to_datetime(self.df['ì‚¬ìš©ì¼ì'])
        
        print(f"âœ… ë¡œë”© ì™„ë£Œ!")
        print(f"   - í–‰ ìˆ˜: {len(self.df):,}")
        print(f"   - ì—´ ìˆ˜: {len(self.df.columns)}")
        
        return self.df
    
    def add_time_features(self):
        """ê³ ê¸‰ ì‹œê°„ í”¼ì²˜ ì¶”ê°€"""
        print("\nâ° ê³ ê¸‰ ì‹œê°„ í”¼ì²˜ ìƒì„± ì¤‘...")
        
        # ìš”ì¼ (0=ì›”ìš”ì¼, 6=ì¼ìš”ì¼)
        self.df['ìš”ì¼'] = self.df['ì‚¬ìš©ì¼ì'].dt.dayofweek
        self.df['ìš”ì¼ëª…'] = self.df['ì‚¬ìš©ì¼ì'].dt.day_name()
        
        # ì£¼ë§ ì—¬ë¶€
        self.df['ì£¼ë§ì—¬ë¶€'] = (self.df['ìš”ì¼'] >= 5).astype(int)
        
        # ì›”ì´ˆ/ì›”ë§ (1~10ì¼: ì´ˆ, 11~20ì¼: ì¤‘, 21ì¼~: ë§)
        self.df['ì›”_êµ¬ê°„'] = pd.cut(self.df['ì‚¬ìš©ì¼ì'].dt.day, 
                                    bins=[0, 10, 20, 31], 
                                    labels=['ì´ˆ', 'ì¤‘', 'ë§'])
        
        # ë¶„ê¸° (1~3ì›”: 1ë¶„ê¸°, 4~6ì›”: 2ë¶„ê¸°, ...)
        self.df['ë¶„ê¸°'] = self.df['ì‚¬ìš©ì¼ì'].dt.quarter
        
        # ì‹œê°„ëŒ€ ì›í•«ì¸ì½”ë”©ì„ ìœ„í•œ ì‚¬ì¸/ì½”ì‚¬ì¸ ë³€í™˜ (ì£¼ê¸°ì„± ë°˜ì˜)
        self.df['ì‹œê°„_sin'] = np.sin(2 * np.pi * self.df['ì‹œê°„'] / 24)
        self.df['ì‹œê°„_cos'] = np.cos(2 * np.pi * self.df['ì‹œê°„'] / 24)
        
        # ìš”ì¼ ì‚¬ì¸/ì½”ì‚¬ì¸ ë³€í™˜ (ì£¼ê¸°ì„± ë°˜ì˜)
        self.df['ìš”ì¼_sin'] = np.sin(2 * np.pi * self.df['ìš”ì¼'] / 7)
        self.df['ìš”ì¼_cos'] = np.cos(2 * np.pi * self.df['ìš”ì¼'] / 7)
        
        # ì›” ì‚¬ì¸/ì½”ì‚¬ì¸ ë³€í™˜ (ê³„ì ˆì„± ë°˜ì˜)
        self.df['ì›”_sin'] = np.sin(2 * np.pi * self.df['ì›”'] / 12)
        self.df['ì›”_cos'] = np.cos(2 * np.pi * self.df['ì›”'] / 12)
        
        print("âœ… ê³ ê¸‰ ì‹œê°„ í”¼ì²˜ ì¶”ê°€ ì™„ë£Œ!")
        print("   - ì¶”ê°€ëœ í”¼ì²˜: ìš”ì¼, ì£¼ë§ì—¬ë¶€, ì›”_êµ¬ê°„, ë¶„ê¸°, ì‹œê°„_sin/cos, ìš”ì¼_sin/cos, ì›”_sin/cos")
        
        return self.df
    
    def add_holiday_features(self):
        """ê³µíœ´ì¼ í”¼ì²˜ ì¶”ê°€"""
        print("\nğŸ“… ê³µíœ´ì¼ í”¼ì²˜ ìƒì„± ì¤‘...")
        
        # ëŒ€í•œë¯¼êµ­ ì£¼ìš” ê³µíœ´ì¼ ì •ì˜ (2015~2025)
        holidays = [
            # 2015ë…„
            '2015-01-01', '2015-02-18', '2015-02-19', '2015-02-20',
            '2015-03-01', '2015-05-05', '2015-05-25', '2015-06-06',
            '2015-08-15', '2015-09-26', '2015-09-27', '2015-09-28', '2015-09-29',
            '2015-10-03', '2015-10-09', '2015-12-25',
            
            # 2016ë…„
            '2016-01-01', '2016-02-07', '2016-02-08', '2016-02-09', '2016-02-10',
            '2016-03-01', '2016-04-13', '2016-05-05', '2016-05-14', '2016-06-06',
            '2016-08-15', '2016-09-14', '2016-09-15', '2016-09-16',
            '2016-10-03', '2016-10-09', '2016-12-25',
            
            # 2017ë…„
            '2017-01-01', '2017-01-27', '2017-01-28', '2017-01-29', '2017-01-30',
            '2017-03-01', '2017-05-03', '2017-05-05', '2017-05-09', '2017-06-06',
            '2017-08-15', '2017-10-02', '2017-10-03', '2017-10-04', '2017-10-05', '2017-10-06',
            '2017-10-09', '2017-12-25',
            
            # 2018ë…„
            '2018-01-01', '2018-02-15', '2018-02-16', '2018-02-17',
            '2018-03-01', '2018-05-05', '2018-05-07', '2018-05-22', '2018-06-06', '2018-06-13',
            '2018-08-15', '2018-09-23', '2018-09-24', '2018-09-25', '2018-09-26',
            '2018-10-03', '2018-10-09', '2018-12-25',
            
            # 2019ë…„
            '2019-01-01', '2019-02-04', '2019-02-05', '2019-02-06',
            '2019-03-01', '2019-05-05', '2019-05-06', '2019-05-12', '2019-06-06',
            '2019-08-15', '2019-09-12', '2019-09-13', '2019-09-14',
            '2019-10-03', '2019-10-09', '2019-12-25',
            
            # 2020ë…„
            '2020-01-01', '2020-01-24', '2020-01-25', '2020-01-26', '2020-01-27',
            '2020-03-01', '2020-04-15', '2020-04-30', '2020-05-05', '2020-06-06',
            '2020-08-15', '2020-08-17', '2020-09-30', '2020-10-01', '2020-10-02',
            '2020-10-03', '2020-10-09', '2020-12-25',
            
            # 2021ë…„
            '2021-01-01', '2021-02-11', '2021-02-12', '2021-02-13',
            '2021-03-01', '2021-05-05', '2021-05-19', '2021-06-06',
            '2021-08-15', '2021-09-20', '2021-09-21', '2021-09-22',
            '2021-10-03', '2021-10-04', '2021-10-09', '2021-12-25',
            
            # 2022ë…„
            '2022-01-01', '2022-01-31', '2022-02-01', '2022-02-02',
            '2022-03-01', '2022-03-09', '2022-05-05', '2022-05-08', '2022-06-01', '2022-06-06',
            '2022-08-15', '2022-09-09', '2022-09-10', '2022-09-11', '2022-09-12',
            '2022-10-03', '2022-10-09', '2022-10-10', '2022-12-25',
            
            # 2023ë…„
            '2023-01-01', '2023-01-21', '2023-01-22', '2023-01-23', '2023-01-24',
            '2023-03-01', '2023-05-05', '2023-05-27', '2023-05-29', '2023-06-06',
            '2023-08-15', '2023-09-28', '2023-09-29', '2023-09-30',
            '2023-10-03', '2023-10-09', '2023-12-25',
            
            # 2024ë…„
            '2024-01-01', '2024-02-09', '2024-02-10', '2024-02-11', '2024-02-12',
            '2024-03-01', '2024-04-10', '2024-05-05', '2024-05-06', '2024-05-15', '2024-06-06',
            '2024-08-15', '2024-09-16', '2024-09-17', '2024-09-18',
            '2024-10-03', '2024-10-09', '2024-12-25',
            
            # 2025ë…„
            '2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30',
            '2025-03-01', '2025-03-03', '2025-05-05', '2025-05-06', '2025-06-06',
            '2025-08-15', '2025-10-03', '2025-10-05', '2025-10-06', '2025-10-07', '2025-10-08',
            '2025-10-09', '2025-12-25',
        ]
        
        # ë‚ ì§œ ë¬¸ìì—´ì„ datetimeìœ¼ë¡œ ë³€í™˜
        holidays = pd.to_datetime(holidays)
        
        # ê³µíœ´ì¼ ì—¬ë¶€ í™•ì¸
        self.df['ê³µíœ´ì¼ì—¬ë¶€'] = self.df['ì‚¬ìš©ì¼ì'].isin(holidays).astype(int)
        
        # ê³µíœ´ì¼ ì „ë‚  (ê¸ˆìš”ì¼ ì €ë… ê°™ì€ íš¨ê³¼)
        self.df['ê³µíœ´ì¼ì „ë‚ '] = (self.df['ì‚¬ìš©ì¼ì'] + timedelta(days=1)).isin(holidays).astype(int)
        
        # ê³µíœ´ì¼ ë‹¤ìŒë‚  (ì—°íœ´ ë§ˆì§€ë§‰ ë‚  ê°™ì€ íš¨ê³¼)
        self.df['ê³µíœ´ì¼ë‹¤ìŒë‚ '] = (self.df['ì‚¬ìš©ì¼ì'] - timedelta(days=1)).isin(holidays).astype(int)
        
        # ì—°íœ´ ì—¬ë¶€ (ê³µíœ´ì¼ + ì£¼ë§)
        self.df['ì—°íœ´ì—¬ë¶€'] = ((self.df['ê³µíœ´ì¼ì—¬ë¶€'] == 1) | (self.df['ì£¼ë§ì—¬ë¶€'] == 1)).astype(int)
        
        print("âœ… ê³µíœ´ì¼ í”¼ì²˜ ì¶”ê°€ ì™„ë£Œ!")
        print(f"   - ê³µíœ´ì¼ ìˆ˜: {self.df['ê³µíœ´ì¼ì—¬ë¶€'].sum():,}ê°œ")
        
        return self.df
    
    def add_lag_features(self):
        """ì‹œê³„ì—´ ì§€ì—°(lag) í”¼ì²˜ ì¶”ê°€"""
        print("\nğŸ“Š ì‹œê³„ì—´ ì§€ì—° í”¼ì²˜ ìƒì„± ì¤‘...")
        
        # ì—­-ì‹œê°„ëŒ€ë³„ë¡œ ì •ë ¬
        self.df = self.df.sort_values(['ì§€í•˜ì² ì—­', 'ì‚¬ìš©ì¼ì', 'ì‹œê°„'])
        
        # ê°™ì€ ì—­, ê°™ì€ ì‹œê°„ëŒ€ì˜ ì´ì „ ë°ì´í„° ê¸°ë°˜ í”¼ì²˜
        # (ì˜ˆ: ì§€ë‚œì£¼ ê°™ì€ ìš”ì¼, ê°™ì€ ì‹œê°„ëŒ€ì˜ ìŠ¹í•˜ì°¨ ì¸ì›)
        
        # 1ì¼ ì „ (24ì‹œê°„ ì „, ê°™ì€ ì‹œê°„ëŒ€)
        self.df['ìŠ¹í•˜ì°¨_1ì¼ì „'] = self.df.groupby(['ì§€í•˜ì² ì—­', 'ì‹œê°„'])['ì´ìŠ¹í•˜ì°¨ì¸ì›'].shift(1)
        
        # 7ì¼ ì „ (1ì£¼ì¼ ì „, ê°™ì€ ìš”ì¼/ì‹œê°„ëŒ€)
        self.df['ìŠ¹í•˜ì°¨_7ì¼ì „'] = self.df.groupby(['ì§€í•˜ì² ì—­', 'ì‹œê°„'])['ì´ìŠ¹í•˜ì°¨ì¸ì›'].shift(7)
        
        # ì´ë™ í‰ê·  (ìµœê·¼ 3ì¼)
        self.df['ìŠ¹í•˜ì°¨_3ì¼í‰ê· '] = self.df.groupby(['ì§€í•˜ì² ì—­', 'ì‹œê°„'])['ì´ìŠ¹í•˜ì°¨ì¸ì›'].transform(
            lambda x: x.rolling(window=3, min_periods=1).mean()
        )
        
        # ì´ë™ í‰ê·  (ìµœê·¼ 7ì¼)
        self.df['ìŠ¹í•˜ì°¨_7ì¼í‰ê· '] = self.df.groupby(['ì§€í•˜ì² ì—­', 'ì‹œê°„'])['ì´ìŠ¹í•˜ì°¨ì¸ì›'].transform(
            lambda x: x.rolling(window=7, min_periods=1).mean()
        )
        
        # ì´ë™ í‘œì¤€í¸ì°¨ (ìµœê·¼ 7ì¼ì˜ ë³€ë™ì„±)
        self.df['ìŠ¹í•˜ì°¨_7ì¼í‘œì¤€í¸ì°¨'] = self.df.groupby(['ì§€í•˜ì² ì—­', 'ì‹œê°„'])['ì´ìŠ¹í•˜ì°¨ì¸ì›'].transform(
            lambda x: x.rolling(window=7, min_periods=1).std()
        )
        
        # ê²°ì¸¡ì¹˜ë¥¼ 0ìœ¼ë¡œ ì±„ìš°ê¸°
        lag_cols = ['ìŠ¹í•˜ì°¨_1ì¼ì „', 'ìŠ¹í•˜ì°¨_7ì¼ì „', 'ìŠ¹í•˜ì°¨_3ì¼í‰ê· ', 'ìŠ¹í•˜ì°¨_7ì¼í‰ê· ', 'ìŠ¹í•˜ì°¨_7ì¼í‘œì¤€í¸ì°¨']
        self.df[lag_cols] = self.df[lag_cols].fillna(0)
        
        print("âœ… ì‹œê³„ì—´ ì§€ì—° í”¼ì²˜ ì¶”ê°€ ì™„ë£Œ!")
        print("   - ì¶”ê°€ëœ í”¼ì²˜: 1ì¼ì „, 7ì¼ì „, 3ì¼í‰ê· , 7ì¼í‰ê· , 7ì¼í‘œì¤€í¸ì°¨")
        
        return self.df
    
    def add_station_features(self):
        """ì—­ ê´€ë ¨ í”¼ì²˜ ì¶”ê°€"""
        print("\nğŸš‰ ì—­ ê´€ë ¨ í”¼ì²˜ ìƒì„± ì¤‘...")
        
        # ì—­ë³„ ìµœëŒ€/ìµœì†Œ ìŠ¹í•˜ì°¨ ì¸ì›
        station_stats = self.df.groupby('ì§€í•˜ì² ì—­')['ì´ìŠ¹í•˜ì°¨ì¸ì›'].agg(['max', 'min']).reset_index()
        station_stats.columns = ['ì§€í•˜ì² ì—­', 'ì—­_ìµœëŒ€ìŠ¹í•˜ì°¨', 'ì—­_ìµœì†ŒìŠ¹í•˜ì°¨']
        
        self.df = self.df.merge(station_stats, on='ì§€í•˜ì² ì—­', how='left')
        
        # í˜„ì¬ ìŠ¹í•˜ì°¨ ì¸ì›ì˜ ì—­ ë‚´ ë¹„ìœ¨
        self.df['ì—­ë‚´_ìƒëŒ€í˜¼ì¡ë„'] = self.df['ì´ìŠ¹í•˜ì°¨ì¸ì›'] / (self.df['ì—­_í‰ê· ìŠ¹í•˜ì°¨'] + 1)
        
        # í™˜ìŠ¹ì—­ ì—¬ë¶€ (í˜¸ì„ ëª…ì— '-' ë˜ëŠ” ',' í¬í•¨)
        self.df['í™˜ìŠ¹ì—­ì—¬ë¶€'] = self.df['í˜¸ì„ ëª…'].str.contains('-|,', regex=True).astype(int)
        
        print("âœ… ì—­ ê´€ë ¨ í”¼ì²˜ ì¶”ê°€ ì™„ë£Œ!")
        
        return self.df
    
    def add_interaction_features(self):
        """ìƒí˜¸ì‘ìš© í”¼ì²˜ ì¶”ê°€ (í”¼ì²˜ ê°„ ì¡°í•©)"""
        print("\nğŸ”— ìƒí˜¸ì‘ìš© í”¼ì²˜ ìƒì„± ì¤‘...")
        
        # ì‹œê°„ëŒ€ Ã— ìš”ì¼ ìƒí˜¸ì‘ìš©
        self.df['ì‹œê°„_ìš”ì¼_ì¡°í•©'] = self.df['ì‹œê°„'].astype(str) + '_' + self.df['ìš”ì¼'].astype(str)
        
        # ì‹œê°„ëŒ€ Ã— ì£¼ë§ ìƒí˜¸ì‘ìš©
        self.df['ì‹œê°„_ì£¼ë§_ì¡°í•©'] = self.df['ì‹œê°„'].astype(str) + '_' + self.df['ì£¼ë§ì—¬ë¶€'].astype(str)
        
        # í˜¸ì„  Ã— ì‹œê°„ëŒ€ ìƒí˜¸ì‘ìš©
        self.df['í˜¸ì„ _ì‹œê°„_ì¡°í•©'] = self.df['í˜¸ì„ ëª…'] + '_' + self.df['ì‹œê°„'].astype(str)
        
        print("âœ… ìƒí˜¸ì‘ìš© í”¼ì²˜ ì¶”ê°€ ì™„ë£Œ!")
        
        return self.df
    
    def encode_categorical_features(self):
        """ë²”ì£¼í˜• í”¼ì²˜ ì¸ì½”ë”©"""
        print("\nğŸ”¢ ë²”ì£¼í˜• í”¼ì²˜ ì¸ì½”ë”© ì¤‘...")
        
        from sklearn.preprocessing import LabelEncoder
        
        # ë¼ë²¨ ì¸ì½”ë”©í•  ì»¬ëŸ¼ë“¤
        categorical_cols = ['í˜¸ì„ ëª…', 'ì§€í•˜ì² ì—­', 'ì‹œê°„ëŒ€êµ¬ë¶„', 'í˜¼ì¡ë„', 'ì›”_êµ¬ê°„']
        
        self.label_encoders = {}
        
        for col in categorical_cols:
            if col in self.df.columns:
                le = LabelEncoder()
                self.df[f'{col}_encoded'] = le.fit_transform(self.df[col].astype(str))
                self.label_encoders[col] = le
                print(f"   - {col}: {len(le.classes_)}ê°œ ë²”ì£¼")
        
        print("âœ… ë²”ì£¼í˜• í”¼ì²˜ ì¸ì½”ë”© ì™„ë£Œ!")
        
        return self.df
    
    def select_features(self):
        """ìµœì¢… í”¼ì²˜ ì„ íƒ ë° ì •ë¦¬"""
        print("\nâœ‚ï¸ ìµœì¢… í”¼ì²˜ ì„ íƒ ì¤‘...")
        
        # í•™ìŠµì— ì‚¬ìš©í•  í”¼ì²˜ ëª©ë¡
        feature_columns = [
            # ì‹œê°„ í”¼ì²˜
            'ì‹œê°„', 'ìš”ì¼', 'ì›”', 'ì—°ë„', 'ë¶„ê¸°',
            'ì‹œê°„_sin', 'ì‹œê°„_cos', 'ìš”ì¼_sin', 'ìš”ì¼_cos', 'ì›”_sin', 'ì›”_cos',
            'ì£¼ë§ì—¬ë¶€', 'ê³µíœ´ì¼ì—¬ë¶€', 'ê³µíœ´ì¼ì „ë‚ ', 'ê³µíœ´ì¼ë‹¤ìŒë‚ ', 'ì—°íœ´ì—¬ë¶€',
            
            # í†µê³„ í”¼ì²˜
            'ì—­_í‰ê· ìŠ¹í•˜ì°¨', 'ì‹œê°„_í‰ê· ìŠ¹í•˜ì°¨', 'í˜¸ì„ _í‰ê· ìŠ¹í•˜ì°¨',
            'ì—­_ìµœëŒ€ìŠ¹í•˜ì°¨', 'ì—­_ìµœì†ŒìŠ¹í•˜ì°¨', 'ì—­ë‚´_ìƒëŒ€í˜¼ì¡ë„',
            
            # ì‹œê³„ì—´ í”¼ì²˜
            'ìŠ¹í•˜ì°¨_1ì¼ì „', 'ìŠ¹í•˜ì°¨_7ì¼ì „', 'ìŠ¹í•˜ì°¨_3ì¼í‰ê· ', 'ìŠ¹í•˜ì°¨_7ì¼í‰ê· ', 'ìŠ¹í•˜ì°¨_7ì¼í‘œì¤€í¸ì°¨',
            
            # ë²”ì£¼í˜• í”¼ì²˜ (ì¸ì½”ë”©ëœ)
            'í˜¸ì„ ëª…_encoded', 'ì§€í•˜ì² ì—­_encoded', 'ì‹œê°„ëŒ€êµ¬ë¶„_encoded',
            
            # ê¸°íƒ€
            'í™˜ìŠ¹ì—­ì—¬ë¶€', 'ìŠ¹ì°¨ì¸ì›', 'í•˜ì°¨ì¸ì›',
        ]
        
        # íƒ€ê²Ÿ ë³€ìˆ˜
        target_column = 'í˜¼ì¡ë„ë ˆë²¨'
        
        # ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ ì„ íƒ
        available_features = [col for col in feature_columns if col in self.df.columns]
        
        print(f"âœ… ìµœì¢… í”¼ì²˜ ìˆ˜: {len(available_features)}ê°œ")
        print(f"   íƒ€ê²Ÿ ë³€ìˆ˜: {target_column}")
        
        # í”¼ì²˜ì™€ íƒ€ê²Ÿì´ í¬í•¨ëœ ë°ì´í„°í”„ë ˆì„
        self.feature_df = self.df[available_features + [target_column, 'ì‚¬ìš©ì¼ì', 'ì§€í•˜ì² ì—­', 'í˜¸ì„ ëª…', 'ì´ìŠ¹í•˜ì°¨ì¸ì›']].copy()
        
        return self.feature_df
    
    def save_feature_data(self, filename='subway_features.csv'):
        """í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ëœ ë°ì´í„° ì €ì¥"""
        filepath = os.path.join(self.feature_data_path, filename)
        
        print(f"\nğŸ’¾ í”¼ì²˜ ë°ì´í„° ì €ì¥ ì¤‘: {filepath}")
        
        self.feature_df.to_csv(filepath, index=False, encoding='utf-8-sig')
        
        print(f"âœ… ì €ì¥ ì™„ë£Œ!")
        print(f"   - ìµœì¢… í–‰ ìˆ˜: {len(self.feature_df):,}")
        print(f"   - ìµœì¢… ì—´ ìˆ˜: {len(self.feature_df.columns)}")
        print(f"   - íŒŒì¼ í¬ê¸°: {os.path.getsize(filepath) / 1024**2:.2f} MB")
        
        return filepath
    
    def get_summary(self):
        """í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ê²°ê³¼ ìš”ì•½"""
        print("\n" + "="*60)
        print("ğŸ“‹ í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ê²°ê³¼ ìš”ì•½")
        print("="*60)
        
        print(f"\nì´ ë°ì´í„° ìˆ˜: {len(self.feature_df):,}ê°œ")
        print(f"ì´ í”¼ì²˜ ìˆ˜: {len(self.feature_df.columns)}ê°œ")
        
        print("\ní”¼ì²˜ ëª©ë¡:")
        for i, col in enumerate(self.feature_df.columns, 1):
            print(f"{i}. {col}")
        
        print("\ní˜¼ì¡ë„ ë ˆë²¨ ë¶„í¬:")
        print(self.feature_df['í˜¼ì¡ë„ë ˆë²¨'].value_counts().sort_index())
        
        print("\nê²°ì¸¡ì¹˜ í™•ì¸:")
        missing = self.feature_df.isnull().sum()
        if missing.sum() > 0:
            print(missing[missing > 0])
        else:
            print("âœ… ê²°ì¸¡ì¹˜ ì—†ìŒ")


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    
    print("ğŸš‡ ì§€í•˜ì²  í˜¼ì¡ë„ ì˜ˆì¸¡ - í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ì‹œì‘")
    print("="*60)
    
    # ê²½ë¡œ ì„¤ì •
    PROCESSED_DATA_PATH = 'data/processed'
    FEATURE_DATA_PATH = 'data/processed'  # ê°™ì€ í´ë”ì— ì €ì¥
    
    # í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ê°ì²´ ìƒì„±
    fe = FeatureEngineer(PROCESSED_DATA_PATH, FEATURE_DATA_PATH)
    
    try:
        # 1. ë°ì´í„° ë¡œë“œ
        fe.load_processed_data()
        
        # 2. ê³ ê¸‰ ì‹œê°„ í”¼ì²˜ ì¶”ê°€
        fe.add_time_features()
        
        # 3. ê³µíœ´ì¼ í”¼ì²˜ ì¶”ê°€
        fe.add_holiday_features()
        
        # 4. ì‹œê³„ì—´ ì§€ì—° í”¼ì²˜ ì¶”ê°€
        fe.add_lag_features()
        
        # 5. ì—­ ê´€ë ¨ í”¼ì²˜ ì¶”ê°€
        fe.add_station_features()
        
        # 6. ìƒí˜¸ì‘ìš© í”¼ì²˜ ì¶”ê°€
        fe.add_interaction_features()
        
        # 7. ë²”ì£¼í˜• í”¼ì²˜ ì¸ì½”ë”©
        fe.encode_categorical_features()
        
        # 8. ìµœì¢… í”¼ì²˜ ì„ íƒ
        fe.select_features()
        
        # 9. ì €ì¥
        fe.save_feature_data()
        
        # 10. ìš”ì•½
        fe.get_summary()
        
        print("\nâœ… í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ì™„ë£Œ!")
        
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()


if __name__ == '__main__':
    main()
